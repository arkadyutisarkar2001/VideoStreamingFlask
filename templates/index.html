<!DOCTYPE html>
<html lang="en">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.6.0/dist/chart.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">

<head>
    <title>Sensor and Camera</title>
    <style>
        #map {
            width:99%;
            height: 400px;
        }
        .flex-container{
            display:flex;

        }

        img {
  	display: flex;
  	/* margin-left: auto;
  	margin-right: auto; */
    aspect-ratio:16px/9px ;
	width:50%;
    height:auto;
	} 
    </style>
</head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<title>Sensor Data Chart</title>

<body>
 <div style="width: auto;">
    <div id="warning" class="alert alert-primary" role="alert" style="display:none">
        Data Logging System Has Problem!
    </div>
    <div class="flex-container">

        <img id="bg" class="left" src="{{ url_for('video_feed') }}">
        <div style="width:49%;height:auto;">
        <div  style="height:200px">
            <canvas id="sensor-chart"></canvas>
        </div>
        <div id="map"></div>
    </div>
    </div>
</div>
</body>
<script>
    $(document).ready(function () {

        var ctx = $('#sensor-chart');

        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humidity',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 3
                }, {
                    label: 'Temparature',
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 3
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        type: 'time',

                        time: {
                            unit: 'second'
                        },
                        distribution: 'linear'
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: false
                        }
                    }]
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
        setInterval(function () {
            $.ajax({
                type: 'POST',
                url: '{{ url_for("data") }}',
                success: function (response) {
                    console.log(response);
                    if (response.status == true) {
                        $("#warning").show();
                    }
                    else {
                        $("#warning").hide();
                    }
                    if (!response?.error) {
                        var now = new Date();
                        chart.data.labels.push(now.toLocaleTimeString());
                        chart.data.datasets[0].data.push(response.humidity);
                        chart.data.datasets[1].data.push(response.temparature);
                        if (chart.data.labels.length > 11) {
                            chart.data.labels.shift();
                            chart.data.datasets[0].data.shift();
                            chart.data.datasets[1].data.shift();
                        }
                        chart.update({
                            duration: 80,
                            easing: 'linear'
                        });
                    }

                }
            });
        }, 1000);
    });
</script>


<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Initialize the map
    var lat, l
    var mymap = L.map('map').setView([0.0000, 0.0000], 20);

    // Add a tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 70
    }).addTo(mymap);
    var locations = [];
    // Create a marker at the Raspberry Pi location
    var marker = L.marker([0.000, 0.000]).addTo(mymap);
    var polyline = L.polyline(locations, { color: 'red' }).addTo(mymap);
    // Update the marker position periodically
    setInterval(function () {

        $.ajax({
            url: '/data',
            type: 'POST',
            success: function (data) {
                // Update the map view and marker position
                mymap.setView([data.lat, data.long], mymap.getZoom());
                marker.setLatLng([data.lat, data.long]);
                locations.push([data.lat, data.long]);

                polyline.setLatLngs(locations);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error:', textStatus, errorThrown);
            }
        });

    }, 10000);  // Update every 10 seconds
</script>

</html>